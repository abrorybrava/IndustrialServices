@{
    ViewData["Title"] = "Draft Article";
    var httpcontext = ViewContext.HttpContext;
    string role = httpcontext.Session.GetString("Role");
    string id = httpcontext.Session.GetString("ID");
    if (string.IsNullOrEmpty(role))
    {
        // Session is expired or role is not set, redirect to login layout
        Layout = null;

        <script>
            window.location.href = '@Url.Action("Index", "Login")';
        </script>

        return;
    }
    if (role == "Admin")
    {
        Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    }
    if (role == "Contributor")
    {
        Layout = "~/Views/Shared/_LayoutContributor.cshtml";
    }

}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script>
    $(document).ready(function () {
        $('#summernote').summernote();
    });
</script>
<div class="pagetitle">
    <h1>- Draft Article -</h1>
</div>
<br />

<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Please Fill it in Correctly!</h5>
                    <hr />
                    <br />

                    <!-- Form for editing article data -->
                        <div class="row mb-3">
                            <input type="text" class="form-control" name="id_artikel" id="id_artikel" value="@ViewBag.Id" hidden>
                            <input type="text" class="form-control" name="id_pengelola" id="id_pengelola" hidden>
                        </div>
                    <div class="row mb-3">
                        <label for="tanggal_rilis" class="col-sm-2 col-form-label">Date of Release</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="tanggal_rilis" id="tanggal_rilis" disabled>
                        </div>
                    </div>
                        <div class="row mb-3">
                            <label for="judul_artikel" class="col-sm-2 col-form-label">Article Title</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control" name="judul_artikel" id="judul_artikel" maxlength="225" placeholder="Max Length of Input is 255 digits">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="sampul_artikel" class="col-sm-2 col-form-label">Added Article Cover</label>
                            <div class="col-sm-10">
                                <img src="" id="preview_image" alt="Article Cover" width="70" height="70">
                            </div>
                        </div>
                        <div class="row mb-3">
                        <label for="sampul_artikel" class="col-sm-2 col-form-label">Article Cover (Optional for Edit & in 16:9 ratio)</label>
                            <div class="col-sm-10">
                                <input class="form-control" type="file" name="sampul_artikel" id="sampul_artikel">
                            </div>
                        </div>
                    <div class="row mb-3">
                        <label for="isi_artikel" class="col-sm-2 col-form-label">Article Content</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" name="isi_artikel" id="summernote" rows="10"></textarea>
                        </div>
                    </div>

                        <div class="row mb-3">
                            <div class="col-sm-10">
                                <input class="form-control" id="status" name="status" value="1" hidden />
                            </div>
                        </div>
                        <br />
                        <br />
                        <div class="row mb-3">
                            <div class="col-sm-10">
                            <a class="btn btn-secondary" asp-action="Index" asp-controller="Artikel">Back</a>
                                <button type="submit" class="btn btn-primary" onclick="simpanEdit()">Submit</button>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</section>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script>
    $(document).ready(function () {
        $('#summernote').summernote();
    });
</script>
<script>
    loadArticleData();

    function loadArticleData() {
        var userID = '@id';
        var id_artikel = document.getElementById("id_artikel");
        var id_pengelola = document.getElementById("id_pengelola");
        var judul_artikel = document.getElementById("judul_artikel");
        var sampul_artikel = document.getElementById("sampul_artikel");
        var isi_artikel = document.getElementsByName("isi_artikel")[0];
        var status = document.getElementById("status");

        var hostname = "https://localhost:7033/";
        var url = hostname + "GetArtikel?id=" + @ViewBag.Id;
        var method = "GET";



        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            success: function (data) {
                var article = data.data;
                id_pengelola.value = article.id_pengelola;
                judul_artikel.value = article.judul_artikel;
                isi_artikel.innerHTML = article.isi_artikel;
                status.value = article.status;
                if (id_pengelola.value != userID) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Access Denied!',
                        text: 'Only the Author of this article has access to edit!'
                    }).then(function () {
                        window.location.href = '/Artikel/Index';
                    });
                    return;
                }
                // Tampilkan pratinjau gambar sampul artikel jika ada
                if (article.sampul_artikel) {
                    var imagePath = "/assets/img/" + article.sampul_artikel;
                    $("#preview_image").attr("src", imagePath);
                }
            }
        });
    }


    function simpanEdit() {
        var id_artikel = document.getElementById("id_artikel").value;
        var id_pengelola = document.getElementById("id_pengelola").value;
        var tanggal_rilis = document.getElementById("tanggal_rilis").value;
        var judul_artikel = document.getElementById("judul_artikel").value;
        var isi_artikel = document.getElementsByName("isi_artikel")[0].value;
        var sampul_artikel = document.getElementById("sampul_artikel").value;
        var status = document.getElementById("status").value;

        var sampulartikel = document.getElementById("sampul_artikel").files[0];

        var hostname = "https://localhost:7033/";
        var url = hostname + "UpdateArtikel";
        var method = "POST";

        if (judul_artikel == '' || isi_artikel == '') {
            Swal.fire({
                icon: 'error',
                title: 'Warning!',
                text: 'Please fill in all fields!',
            });
            return;
        }



        if (sampulartikel != null) {
            uploadFoto(sampulartikel, function (uniqueFileName) {
                var input = {
                    id_artikel: id_artikel,
                    id_pengelola: id_pengelola,
                    tanggal_rilis: tanggal_rilis,
                    judul_artikel: judul_artikel,
                    sampul_artikel: uniqueFileName,
                    isi_artikel: isi_artikel,
                    status: status
                };
                sendUpdateRequest(input);
            });
        } else {
            var input = {
                id_artikel: id_artikel,
                id_pengelola: id_pengelola,
                tanggal_rilis: tanggal_rilis,
                judul_artikel: judul_artikel,
                sampul_artikel: 'null',
                isi_artikel: isi_artikel,
                status: status
            };
            sendUpdateRequest(input);
        }
    }

    function sendUpdateRequest(input) {
        var url = "https://localhost:7033/UpdateArtikel";
        var method = "POST";
        $.ajax({

            url: url,
            method: method,
            data: JSON.stringify(input),
            contentType: "application/json",
            success: function (data) {
                window.location.href = '/Artikel/Index';
            },
            error: function (error) {
                console.log(error);
            }
        });
    }


    function saveData() {
        alert('warning')
        console.log("Simpan data tanpa foto");
    }
    function uploadFoto(file, callback) {
        var maxSize = 7 * 1024 * 1024; // 10 MB

        // Pengecekan ukuran file
        if (file.size > maxSize) {
            Swal.fire({
                icon: 'warning',
                title: 'File Size Exceeded',
                text: 'File size should not exceed 7 MB.'
            });
            // Tidak melanjutkan proses upload jika ukuran file melebihi batas
            location.reload();
        }
        var formData = new FormData();
        var uniqueFileName = guid() + "_" + file.name;
        formData.append('sampulartikel', file, uniqueFileName);

        $.ajax({
            url: '/Artikel/UploadPhoto',
            method: 'POST',
            data: formData,
            contentType: false, // false agar FormData menentukan Content-Type
            processData: false, // false agar FormData tidak diproses
            success: function (response) {
                callback(uniqueFileName);
                window.location.href = '/Artikel/Index';
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0,
                v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function cancelEdit() {
        document.getElementById("judul_artikel").value = "";
        document.getElementById("isi_artikel").value = "";
    }

    document.addEventListener("DOMContentLoaded", function () {
        var today = new Date();

        // Mendapatkan tanggal dalam format yang dapat dimasukkan ke dalam database (yyyy-MM-dd)
        var formattedDate = today.toLocaleDateString('en-CA'); // 'en-CA' adalah kode untuk format 'yyyy-MM-dd'

        // Set nilai default pada input tanggal dengan id "tanggal_rilis"
        document.getElementById('tanggal_rilis').value = formattedDate;
    });
</script>
