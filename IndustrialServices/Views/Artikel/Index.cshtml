@{
    ViewData["Title"] = "Article Data";
    var httpcontext = ViewContext.HttpContext;
    string role = httpcontext.Session.GetString("Role");
    string id = httpcontext.Session.GetString("ID");
    if (string.IsNullOrEmpty(role))
    {
        // Session is expired or role is not set, redirect to login layout
        Layout = null;

        <script>
            window.location.href = '@Url.Action("Index", "Login")';
        </script>

        return;
    }
    if (role == "Admin")
    {
        Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    }
    if (role == "Contributor")
    {
        Layout = "~/Views/Shared/_LayoutContributor.cshtml";
    }
}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script>
    $(document).ready(function () {
        $('#summernote').summernote();
    });
</script>
<div class="pagetitle">
    <h1>Article Data</h1>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Article Table</h5>

                    <a class="btn btn-primary" asp-action="Create" asp-controller="Artikel">+ Add Article</a>
                    <!-- Table with stripped rows -->
                    <table class="table datatable">
                        <thead>
                            <tr>
                                <th scope="col">No</th>
                                <th scope="col">Article Title</th>
                                <th scope="col">Author</th>
                                <th scope="col">Release Date</th>
                                <th scope="col">Status</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyArticle">
                            <!-- Article data will be added here -->
                        </tbody>
                    </table>

                </div>
            </div>

        </div>
    </div>
</section>

<script>
    loadArticles()

    function loadArticles() {
        var hostname = "https://localhost:7033/";
        var url = hostname + "GetAllArtikel";
        var method = "GET";

        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            success: function (data) {
                var articles = data.data; // Assuming data is returned in the correct format
                articles.forEach(function (article, index) {
                    var formattedDate = formatDate(article.tanggal_rilis);
                    var statusText = getStatusText(article.status);

                    $.ajax({
                        url: hostname + "GetPengelolaWebById?id=" + article.id_pengelola,
                        method: "GET",
                        contentType: "application/json",
                        success: function (pengelola) {
                            var peran = pengelola.data.peran;
                            var nama = pengelola.data.nama_pengelola;
                            var editButton = '';
                            var deleteButton = '';
                            var doneButton = '';
                            var detailButton = '';

                            var userRole = '@role';
                            if (window.location.href === "https://localhost:7240/Artikel/Index" && userRole === "Contributor") {
                                if (article.status === 1) {
                                    editButton = '<a class="btn btn-primary" href="/Artikel/Draft?id=' + article.id_artikel + '"><i class="fas fa-edit"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel(this.value)"><i class="fas fa-trash"></i></button>';
                                } else if (article.status === 2) {
                                    detailButton = '<a class="btn btn-primary" href="/Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel2(this.value)"><i class="fas fa-trash"></i></button>';
                                }
                            } else if (userRole === "Contributor") {
                                if (article.status === 1) {
                                    editButton = '<a class="btn btn-primary" href="Artikel/Draft?id=' + article.id_artikel + '"><i class="fas fa-edit"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel(this.value)"><i class="fas fa-trash"></i></button>';
                                } else if (article.status === 2) {
                                    detailButton = '<a class="btn btn-primary" href="Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel2(this.value)"><i class="fas fa-trash"></i></button>';
                                }
                            }

                            if (window.location.href === "https://localhost:7240/Artikel/Index" && userRole === "Admin") {
                                if (article.status === 1) {
                                    detailButton = '<a class="btn btn-secondary" href="Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    editButton = '<a class="btn btn-primary" href="/Artikel/Draft?id=' + article.id_artikel + '"><i class="fas fa-edit"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel(this.value)"><i class="fas fa-trash"></i></button>';
                                    doneButton = '<button class="btn btn-success" value="' + article.id_artikel + '" onclick="doneArtikel(this.value)"><i class="fa-solid fa-check"></i></button>';
                                } else if (article.status === 2) {
                                    detailButton = '<a class="btn btn-primary" href="/Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel2(this.value)"><i class="fas fa-trash"></i></button>';
                                }
                            } else if (userRole === "Admin") {
                                if (article.status === 1) {
                                    detailButton = '<a class="btn btn-secondary" href="Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    editButton = '<a class="btn btn-primary" href="Artikel/Draft?id=' + article.id_artikel + '"><i class="fas fa-edit"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel(this.value)"><i class="fas fa-trash"></i></button>';
                                    doneButton = '<button class="btn btn-success" value="' + article.id_artikel + '" onclick="doneArtikel(this.value)"><i class="fa-solid fa-check"></i></button>';
                                } else if (article.status === 2) {
                                    detailButton = '<a class="btn btn-primary" href="Artikel/Detail?id=' + article.id_artikel + '"><i class="fa-regular fa-eye"></i></a>';
                                    deleteButton = '<button class="btn btn-danger" value="' + article.id_artikel + '" onclick="deleteArtikel2(this.value)"><i class="fas fa-trash"></i></button>';
                                }
                            }

                            var newRow = '<tr>' +
                                '<td>' + (index + 1) + '</td>' +
                                '<td>' + article.judul_artikel + '</td>' +
                                '<td>' + nama + ' ('+ peran + ')' + '</td>' +
                                '<td>' + formattedDate + '</td>' +
                                '<td>' + statusText + '</td>' +
                                '<td>' +
                                detailButton +
                                editButton +
                                deleteButton +
                                doneButton +
                                '</td>' +
                                '</tr>';

                            $('#tbodyArticle').append(newRow);
                        }
                    });
                });
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }


    function deleteArtikel(id) {
        var hostname = "https://localhost:7033/";
        var url = hostname + "DeleteArtikel?id=" + id;
        var method = "POST";

        // Konfirmasi sebelum menghapus menggunakan SweetAlert
        Swal.fire({
            title: 'Are you sure for deleting this Article?',
            text: "This Article will be deleted permanently.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Delete!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Ajax untuk menghapus artikel
                $.ajax({
                    url: url,
                    method: method,
                    contentType: "application/json",
                    success: function (data) {
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error deleting article:", error);
                        // Tangani kesalahan jika terjadi saat menghapus artikel
                    }
                });
            }
        });
    }

    function deleteArtikel2(id) {
        var hostname = "https://localhost:7033/";
        var url = hostname + "DeleteArtikel?id=" + id;
        var method = "POST";

        // Konfirmasi sebelum menghapus menggunakan SweetAlert
        Swal.fire({
            title: 'Are you sure for deleting this Article?',
            text: "This Article will be deleted too in the website.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Delete!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Ajax untuk menghapus artikel
                $.ajax({
                    url: url,
                    method: method,
                    contentType: "application/json",
                    success: function (data) {
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error deleting article:", error);
                        // Tangani kesalahan jika terjadi saat menghapus artikel
                    }
                });
            }
        });
    }


    function doneArtikel(id) {
        var hostname = "https://localhost:7033/";
        var url = hostname + "DoneArtikel?id=" + id
        var method = "POST";

        Swal.fire({
            title: 'Are you sure to publish this article?',
            text: 'You won\'t be able to edit this article again!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, mark it as done!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Ajax untuk menyelesaikan artikel
                $.ajax({
                    url: url,
                    method: method,
                    contentType: "application/json",
                    success: function (data) {
                        // Tampilkan SweetAlert pemberitahuan berhasil
                        Swal.fire(
                            'Done!',
                            'The article has been marked as done.',
                            'success'
                        ).then(function () {
                            location.reload();
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error marking article as done:", error);
                        // Tangani kesalahan jika terjadi saat menyelesaikan artikel
                    }
                });
            }
        });
    }


    function getStatusText(status) {
        if (status === 1) {
            return 'Draft';
        } else if (status === 2) {
            return 'Published';
        } else {
            return 'Unknown';
        }
    }

    function formatDate(dateString) {
        var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        var date = new Date(dateString);
        return date.toLocaleDateString('en-US', options);
    }
</script>